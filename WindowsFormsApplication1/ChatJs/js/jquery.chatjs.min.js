(function($){var defaults={className:"autosizejs",id:"autosizejs",append:"",callback:false,resizeDelay:10,placeholder:true},copy='<textarea tabindex="-1" style="position:absolute; top:-999px; left:0; right:auto; bottom:auto; border:0; padding: 0; -moz-box-sizing:content-box; -webkit-box-sizing:content-box; box-sizing:content-box; word-wrap:break-word; height:0 !important; min-height:0 !important; overflow:hidden; transition:none; -webkit-transition:none; -moz-transition:none;"/>',typographyStyles=["fontFamily","fontSize","fontWeight","fontStyle","letterSpacing","textTransform","wordSpacing","textIndent"],mirrored,mirror=$(copy).data("autosize",true)[0];mirror.style.lineHeight="99px";if($(mirror).css("lineHeight")==="99px"){typographyStyles.push("lineHeight")}mirror.style.lineHeight="";$.fn.autosize=function(options){if(!this.length){return this}options=$.extend({},defaults,options||{});if(mirror.parentNode!==document.body){$(document.body).append(mirror)}return this.each(function(){var ta=this,$ta=$(ta),maxHeight,minHeight,boxOffset=0,callback=$.isFunction(options.callback),originalStyles={height:ta.style.height,overflow:ta.style.overflow,overflowY:ta.style.overflowY,wordWrap:ta.style.wordWrap,resize:ta.style.resize},timeout,width=$ta.width();if($ta.data("autosize")){return}$ta.data("autosize",true);if($ta.css("box-sizing")==="border-box"||$ta.css("-moz-box-sizing")==="border-box"||$ta.css("-webkit-box-sizing")==="border-box"){boxOffset=$ta.outerHeight()-$ta.height()}minHeight=Math.max(parseInt($ta.css("minHeight"),10)-boxOffset||0,$ta.height());$ta.css({overflow:"hidden",overflowY:"hidden",wordWrap:"break-word",resize:$ta.css("resize")==="none"||$ta.css("resize")==="vertical"?"none":"horizontal"});function setWidth(){var width;var style=window.getComputedStyle?window.getComputedStyle(ta,null):false;if(style){width=ta.getBoundingClientRect().width;if(width===0){width=parseInt(style.width,10)}$.each(["paddingLeft","paddingRight","borderLeftWidth","borderRightWidth"],function(i,val){width-=parseInt(style[val],10)})}else{width=Math.max($ta.width(),0)}mirror.style.width=width+"px"}function initMirror(){var styles={};mirrored=ta;mirror.className=options.className;mirror.id=options.id;maxHeight=parseInt($ta.css("maxHeight"),10);$.each(typographyStyles,function(i,val){styles[val]=$ta.css(val)});$(mirror).css(styles);setWidth();if(window.chrome){var width=ta.style.width;ta.style.width="0px";var ignore=ta.offsetWidth;ta.style.width=width}}function adjust(){var height,original;if(mirrored!==ta){initMirror()}else{setWidth()}if(!ta.value&&options.placeholder){mirror.value=($ta.attr("placeholder")||"")+options.append}else{mirror.value=ta.value+options.append}mirror.style.overflowY=ta.style.overflowY;original=parseInt(ta.style.height,10);mirror.scrollTop=0;mirror.scrollTop=9e4;height=mirror.scrollTop;if(maxHeight&&height>maxHeight){ta.style.overflowY="scroll";height=maxHeight}else{ta.style.overflowY="hidden";if(height<minHeight){height=minHeight}}height+=boxOffset;if(original!==height){ta.style.height=height+"px";if(callback){options.callback.call(ta,ta)}}}function resize(){clearTimeout(timeout);timeout=setTimeout(function(){var newWidth=$ta.width();if(newWidth!==width){width=newWidth;adjust()}},parseInt(options.resizeDelay,10))}if("onpropertychange"in ta){if("oninput"in ta){$ta.on("input.autosize keyup.autosize",adjust)}else{$ta.on("propertychange.autosize",function(){if(event.propertyName==="value"){adjust()}})}}else{$ta.on("input.autosize",adjust)}if(options.resizeDelay!==false){$(window).on("resize.autosize",resize)}$ta.on("autosize.resize",adjust);$ta.on("autosize.resizeIncludeStyle",function(){mirrored=null;adjust()});$ta.on("autosize.destroy",function(){mirrored=null;clearTimeout(timeout);$(window).off("resize",resize);$ta.off("autosize").off(".autosize").css(originalStyles).removeData("autosize")});adjust()})}})(window.jQuery||window.$);var ChatJsUtils=function(){function ChatJsUtils(){}ChatJsUtils.setOuterHeight=function(jQuery,height){var heights=new Array;heights.push(parseInt(jQuery.css("padding-top").replace("px","")));heights.push(parseInt(jQuery.css("padding-bottom").replace("px","")));heights.push(parseInt(jQuery.css("border-top-width").replace("px","")));heights.push(parseInt(jQuery.css("border-bottom-width").replace("px","")));heights.push(parseInt(jQuery.css("margin-top").replace("px","")));heights.push(parseInt(jQuery.css("margin-bottom").replace("px","")));var calculatedHeight=height;for(var i=0;i<heights.length;i++)calculatedHeight-=heights[i];jQuery.height(calculatedHeight)};ChatJsUtils.setOuterWidth=function(jQuery,width){var widths=new Array;widths.push(parseInt(jQuery.css("padding-left").replace("px","")));widths.push(parseInt(jQuery.css("padding-right").replace("px","")));widths.push(parseInt(jQuery.css("border-top-left").replace("px","")));widths.push(parseInt(jQuery.css("border-bottom-right").replace("px","")));widths.push(parseInt(jQuery.css("margin-left").replace("px","")));widths.push(parseInt(jQuery.css("margin-right").replace("px","")));var calculatedWidth=width;for(var i=0;i<widths.length;i++)calculatedWidth-=widths[i];jQuery.width(calculatedWidth)};return ChatJsUtils}();var ChatMessageInfo=function(){function ChatMessageInfo(){}return ChatMessageInfo}();var UserStatusType;(function(UserStatusType){UserStatusType[UserStatusType["Offline"]=0]="Offline";UserStatusType[UserStatusType["Online"]=1]="Online"})(UserStatusType||(UserStatusType={}));var ChatUserInfo=function(){function ChatUserInfo(){}return ChatUserInfo}();var ChatRoomInfo=function(){function ChatRoomInfo(){}return ChatRoomInfo}();var ChatTypingSignalInfo=function(){function ChatTypingSignalInfo(){}return ChatTypingSignalInfo}();var ChatUserListChangedInfo=function(){function ChatUserListChangedInfo(){}return ChatUserListChangedInfo}();var ChatRoomListChangedInfo=function(){function ChatRoomListChangedInfo(){}return ChatRoomListChangedInfo}();var SignalRServerAdapter=function(){function SignalRServerAdapter(chatHubServer){this.hubServer=chatHubServer}SignalRServerAdapter.prototype.sendMessage=function(roomId,conversationId,otherUserId,messageText,clientGuid,done){this.hubServer.sendMessage(roomId,conversationId,otherUserId,messageText,clientGuid).done(function(){done()})};SignalRServerAdapter.prototype.sendTypingSignal=function(roomId,conversationId,userToId,done){this.hubServer.sendTypingSignal(roomId,conversationId,userToId).done(function(){done()})};SignalRServerAdapter.prototype.getMessageHistory=function(roomId,conversationId,otherUserId,done){this.hubServer.getMessageHistory(roomId,conversationId,otherUserId).done(function(messageHistory){done(messageHistory)})};SignalRServerAdapter.prototype.getUserInfo=function(userId,done){this.hubServer.getUserInfo(userId).done(function(userInfo){done(userInfo)})};SignalRServerAdapter.prototype.getUserList=function(roomId,conversationId,done){this.hubServer.getUserList(roomId,conversationId).done(function(userList){done(userList)})};SignalRServerAdapter.prototype.getRoomsList=function(done){this.hubServer.getRoomsList().done(function(roomsList){done(roomsList)})};SignalRServerAdapter.prototype.enterRoom=function(roomId,done){this.hubServer.enterRoom(roomId).done(function(){done()})};SignalRServerAdapter.prototype.leaveRoom=function(roomId,done){this.hubServer.leaveRoom(roomId).done(function(){done()})};return SignalRServerAdapter}();var SignalRClientAdapter=function(){function SignalRClientAdapter(chatHubClient){var _this=this;this.messagesChangedHandlers=[];this.typingSignalReceivedHandlers=[];this.userListChangedHandlers=[];this.roomListChangedHandlers=[];this.hubClient=chatHubClient;this.hubClient.sendMessage=function(message){for(var i=0;i<_this.messagesChangedHandlers.length;i++)_this.messagesChangedHandlers[i](message)};this.hubClient.sendTypingSignal=function(typingSignal){for(var i=0;i<_this.typingSignalReceivedHandlers.length;i++)_this.typingSignalReceivedHandlers[i](typingSignal)};this.hubClient.userListChanged=function(userListChangedInfo){for(var i=0;i<_this.userListChangedHandlers.length;i++)_this.userListChangedHandlers[i](userListChangedInfo)};this.hubClient.roomListChanged=function(roomListChangedInfo){for(var i=0;i<_this.roomListChangedHandlers.length;i++)_this.roomListChangedHandlers[i](roomListChangedInfo)}}SignalRClientAdapter.prototype.onMessagesChanged=function(handler){this.messagesChangedHandlers.push(handler)};SignalRClientAdapter.prototype.onTypingSignalReceived=function(handler){this.typingSignalReceivedHandlers.push(handler)};SignalRClientAdapter.prototype.onUserListChanged=function(handler){this.userListChangedHandlers.push(handler)};SignalRClientAdapter.prototype.onRoomListChanged=function(handler){this.roomListChangedHandlers.push(handler)};return SignalRClientAdapter}();var SignalRAdapterOptions=function(){function SignalRAdapterOptions(){}return SignalRAdapterOptions}();var SignalRAdapter=function(){function SignalRAdapter(options){var defaultOptions=new SignalRAdapterOptions;defaultOptions.chatHubName="chatHub";this.options=$.extend({},defaultOptions,options)}SignalRAdapter.prototype.init=function(done){this.hub=$.connection[this.options.chatHubName];this.client=new SignalRClientAdapter(this.hub.client);this.server=new SignalRServerAdapter(this.hub.server);if(!window.chatJsHubReady)window.chatJsHubReady=$.connection.hub.start();window.chatJsHubReady.done(function(){done()})};return SignalRAdapter}();var ChatJsAutocompleteOptions=function(){function ChatJsAutocompleteOptions(){}return ChatJsAutocompleteOptions}();var ChatJsAutocomplete=function(){function ChatJsAutocomplete($el,options){this.$el=$el;var defaultOptions=new ChatJsAutocompleteOptions;defaultOptions.autoShow=false;this.options=$.extend({},defaultOptions,options);if(this.options.autoShow)this.show()}ChatJsAutocomplete.prototype.show=function(){var $flyout=$("<div/>").addClass("flyout-box").prependTo(this.$el);var $flyoutButtonWrapper=$("<div/>").addClass("button-wrapper").appendTo($flyout);var $flyoutTextWrapper=$("<div/>").addClass("text-wrapper").appendTo($flyout);this.$textBox=$("<input />").attr("type","text").addClass("flyout-text-box").appendTo($flyoutTextWrapper)};ChatJsAutocomplete.prototype.hide=function(){};return ChatJsAutocomplete}();$.fn.chatjsAutocomplete=function(options){if(this.length){this.each(function(){var data=new ChatJsAutocomplete($(this),options);$(this).data("chatjsAutocomplete",data)})}return this};var HorizontalTabsOptions=function(){function HorizontalTabsOptions(){}return HorizontalTabsOptions}();var HorizontalTab=function(){function HorizontalTab($li,$content,onFocus){this.$li=$li;this.$content=$content;this.onFocus=onFocus}return HorizontalTab}();var HorizontalTabs=function(){function HorizontalTabs($el,options){this.$el=$el;var defaultOptions=new HorizontalTabsOptions;defaultOptions.onTabClosed=function(){};this.options=$.extend({},defaultOptions,options);this.$el.addClass("horizontal-tab");this.$contentWrapper=$("<div/>").addClass("tab-content-holder").insertAfter(this.$el);this.tabs={}}HorizontalTabs.prototype.addTab=function(id,displayName,selected,canClose,contentBuilder,onFocus,focusTab,triggerOnFocus){var _this=this;if(typeof selected==="undefined"){selected=false}if(typeof canClose==="undefined"){canClose=true}if(typeof contentBuilder==="undefined"){contentBuilder=null}if(typeof onFocus==="undefined"){onFocus=null}if(typeof focusTab==="undefined"){focusTab=true}if(typeof triggerOnFocus==="undefined"){triggerOnFocus=true}var $li=$("<li/>").attr("data-val-id",id).appendTo(this.$el);this.$titleText=$("<span/>").addClass("text").appendTo($li);this.$titleText.text(displayName);if(canClose){var $closeButton=$("<span/>").addClass("close").appendTo(this.$titleText);$closeButton.on("click",function(e){e.preventDefault();_this.removeTab(id)})}var $content=$("<div/>").addClass("tab-content").appendTo(this.$contentWrapper);if(contentBuilder)contentBuilder($content);this.tabs[id]=new HorizontalTab($li,$content,onFocus);$li.click(function(){_this.focusTab(id)});if(selected&&focusTab)this.focusTab(id,triggerOnFocus)};HorizontalTabs.prototype.removeTab=function(id){var $li=$("li[data-val-id="+id+"]",this.$el);this.options.onTabClosed(id);if(this.tabs[id])delete this.tabs[id];var $siblingTabs=$li.siblings();if($siblingTabs.length){var tabToFocus=$siblingTabs.eq(0);var idToFocus=$(tabToFocus).attr("data-val-id");this.focusTab(parseInt(idToFocus))}$li.remove()};HorizontalTabs.prototype.focusTab=function(tabId,triggerOnFocus){if(typeof triggerOnFocus==="undefined"){triggerOnFocus=true}if(this.tabs[tabId]){$("li",this.$el).removeClass("selected");this.tabs[tabId].$li.addClass("selected");$(".tab-content",this.$contentWrapper).removeClass("selected-tab");this.tabs[tabId].$content.addClass("selected-tab");if(this.tabs[tabId].onFocus&&triggerOnFocus)this.tabs[tabId].onFocus()}};HorizontalTabs.prototype.getFucusedTabId=function(){var $selectedTab=$("li.selected",this.$el);return $selectedTab.length?parseInt($selectedTab.attr("data-val-id")):null};HorizontalTabs.prototype.hasTab=function(tabId){return!!this.tabs[tabId]};HorizontalTabs.prototype.getTab=function(tabId){return this.tabs[tabId]};HorizontalTabs.prototype.getTabIds=function(){var tabIds=[];for(var id in this.tabs)if(!isNaN(id))tabIds.push(id);return tabIds};HorizontalTabs.prototype.addEventMark=function(tabId){var $eventMark=$(".event-mark",this.$titleText);if(!$eventMark.length)$eventMark=$("<span/>").addClass("event-mark").appendTo(this.$titleText);var currentEventCount=$eventMark.text()==""?0:parseInt($eventMark.text());currentEventCount++;$eventMark.text(currentEventCount)};HorizontalTabs.prototype.clearEventMarks=function(tabId){var $eventMark=$(".event-mark",this.$titleText);$eventMark.remove()};return HorizontalTabs}();$.fn.horizontalTabs=function(options){if(this.length){this.each(function(){var data=new HorizontalTabs($(this),options);$(this).data("horizontalTabs",data)})}return this};var ChatWindowOptions=function(){function ChatWindowOptions(){}return ChatWindowOptions}();var ChatWindow=function(){function ChatWindow(options){var _this=this;var defaultOptions=new ChatWindowOptions;defaultOptions.isMaximized=true;defaultOptions.canExpand=true;defaultOptions.canClose=true;defaultOptions.onCreated=function(){};defaultOptions.onClose=function(){};defaultOptions.onMaximizedStateChanged=function(){};this.options=$.extend({},defaultOptions,options);if(this.options.canExpand){this.$windowTray=$("<div/>").addClass("chat-window-tray").appendTo($("body"));this.$windowTray.on("click",function(){_this.toggleMaximizedState()})}this.$window=$("<div/>").addClass("chat-window").appendTo($("body"));if(this.options.canExpand)this.$window.addClass("expansible");if(this.options.width)this.$window.css("width",this.options.width);if(this.options.height)this.$window.css("height",this.options.height);this.$windowTitle=$("<div/>").addClass("chat-window-title").appendTo(this.$window);if(this.options.canClose){var $closeButton=$("<div/>").addClass("close").appendTo(this.$windowTitle);$closeButton.click(function(e){e.stopPropagation();_this.$window.remove();_this.options.onClose(_this)})}$("<div/>").addClass("text").text(this.options.title).appendTo(this.$windowTitle);this.$windowContent=$("<div/>").addClass("chat-window-content").appendTo(this.$window);this.$windowInnerContent=$("<div/>").addClass("chat-window-inner-content").appendTo(this.$windowContent);this.$windowTitle.click(function(){_this.toggleMaximizedState()});this.setMaximized(this.options.isMaximized,false);this.options.onCreated(this)}ChatWindow.prototype.getWidth=function(){return this.options.canExpand?this.$windowTray.outerWidth():this.$window.outerWidth()};ChatWindow.prototype.setRightOffset=function(offset){this.$window.css("right",offset);if(this.options.canExpand)this.$windowTray.css("right",offset)};ChatWindow.prototype.setTitle=function(title){$("div[class=text]",this.$windowTitle).text(title)};ChatWindow.prototype.setVisible=function(visible){if(visible)this.$window.show();else this.$window.hide()};ChatWindow.prototype.isMaximized=function(){return!this.$window.hasClass("minimized")};ChatWindow.prototype.setMaximized=function(isMaximized,triggerMaximizedStateEvent){if(typeof triggerMaximizedStateEvent==="undefined"){triggerMaximizedStateEvent=true}if(!this.options.canExpand){if(isMaximized){this.$window.removeClass("minimized");this.$windowContent.show()}else{this.$window.addClass("minimized");this.$windowContent.hide()}}else{if(isMaximized){this.$window.show();this.$window.removeClass("minimized");this.$windowTray.removeClass("minimized")}else{this.$window.hide();this.$window.addClass("minimized");this.$windowTray.addClass("minimized")}}if(triggerMaximizedStateEvent)this.options.onMaximizedStateChanged(this,isMaximized)};ChatWindow.prototype.toggleMaximizedState=function(){this.setMaximized(this.$window.hasClass("minimized"))};return ChatWindow}();$.chatWindow=function(options){var chatWindow=new ChatWindow(options);return chatWindow};var MessageBoardOptions=function(){function MessageBoardOptions(){}return MessageBoardOptions}();var MessageBoard=function(){function MessageBoard(jQuery,options){var _this=this;this.$el=jQuery;var defaultOptions=new MessageBoardOptions;defaultOptions.typingText=" is typing...";defaultOptions.playSound=true;defaultOptions.height=100;defaultOptions.chatJsContentPath="/content/chatjs/";defaultOptions.newMessage=function(message){};this.options=$.extend({},defaultOptions,options);this.$el.addClass("message-board");ChatJsUtils.setOuterHeight(this.$el,this.options.height);this.$messagesWrapper=$("<div/>").addClass("messages-wrapper").appendTo(this.$el);var $windowTextBoxWrapper=$("<div/>").addClass("chat-window-text-box-wrapper").appendTo(this.$el);this.$textBox=$("<textarea />").attr("rows","1").addClass("chat-window-text-box").appendTo($windowTextBoxWrapper);this.$textBox.autosize({callback:function(ta){var messagesHeight=_this.options.height-$(ta).outerHeight()-2;ChatJsUtils.setOuterHeight(_this.$messagesWrapper,messagesHeight)}});this.$textBox.val(this.$textBox.val());this.options.adapter.client.onTypingSignalReceived(function(typingSignal){var shouldProcessTypingSignal=false;if(_this.options.otherUserId){shouldProcessTypingSignal=typingSignal.UserToId==_this.options.userId&&typingSignal.UserFrom.Id==_this.options.otherUserId}else if(_this.options.roomId){shouldProcessTypingSignal=typingSignal.RoomId==_this.options.roomId&&typingSignal.UserFrom.Id!=_this.options.userId}else if(_this.options.conversationId){shouldProcessTypingSignal=typingSignal.ConversationId==_this.options.conversationId&&typingSignal.UserFrom.Id!=_this.options.userId}if(shouldProcessTypingSignal)_this.showTypingSignal(typingSignal.UserFrom)});this.options.adapter.client.onMessagesChanged(function(message){var shouldProcessMessage=false;if(_this.options.otherUserId){shouldProcessMessage=message.UserFromId==_this.options.userId&&message.UserToId==_this.options.otherUserId||message.UserFromId==_this.options.otherUserId&&message.UserToId==_this.options.userId}else if(_this.options.roomId){shouldProcessMessage=message.RoomId==_this.options.roomId}else if(_this.options.conversationId){shouldProcessMessage=message.ConversationId==_this.options.conversationId}if(shouldProcessMessage){_this.addMessage(message);if(message.UserFromId!=_this.options.userId){if(_this.options.playSound)_this.playSound()}_this.options.newMessage(message)}});this.options.adapter.server.getMessageHistory(this.options.roomId,this.options.conversationId,this.options.otherUserId,function(messages){for(var i=0;i<messages.length;i++){_this.addMessage(messages[i],null,false)}_this.adjustScroll();_this.$textBox.keypress(function(e){if(_this.sendTypingSignalTimeout==undefined){_this.sendTypingSignalTimeout=setTimeout(function(){_this.sendTypingSignalTimeout=undefined},3e3);_this.sendTypingSignal()}if(e.which==13){e.preventDefault();if(_this.$textBox.val()){_this.sendMessage(_this.$textBox.val());_this.$textBox.val("").trigger("autosize.resize")}}})})}MessageBoard.prototype.showTypingSignal=function(user){var _this=this;if(this.$typingSignal)this.$typingSignal.remove();this.$typingSignal=$("<p/>").addClass("typing-signal").text(user.Name+this.options.typingText);this.$messagesWrapper.append(this.$typingSignal);if(this.typingSignalTimeout)clearTimeout(this.typingSignalTimeout);this.typingSignalTimeout=setTimeout(function(){_this.removeTypingSignal()},5e3);this.adjustScroll()};MessageBoard.prototype.removeTypingSignal=function(){if(this.$typingSignal)this.$typingSignal.remove();if(this.typingSignalTimeout)clearTimeout(this.typingSignalTimeout)};MessageBoard.prototype.adjustScroll=function(){this.$messagesWrapper[0].scrollTop=this.$messagesWrapper[0].scrollHeight};MessageBoard.prototype.sendTypingSignal=function(){this.options.adapter.server.sendTypingSignal(this.options.roomId,this.options.conversationId,this.options.otherUserId,function(){})};MessageBoard.prototype.sendMessage=function(messageText){var generateGuidPart=function(){return((1+Math.random())*65536|0).toString(16).substring(1)};var clientGuid=generateGuidPart()+generateGuidPart()+"-"+generateGuidPart()+"-"+generateGuidPart()+"-"+generateGuidPart()+"-"+generateGuidPart()+generateGuidPart()+generateGuidPart();var message=new ChatMessageInfo;message.UserFromId=this.options.userId;message.Message=messageText;this.addMessage(message,clientGuid);this.options.adapter.server.sendMessage(this.options.roomId,this.options.conversationId,this.options.otherUserId,messageText,clientGuid,function(){})};MessageBoard.prototype.playSound=function(){var $soundContainer=$("#soundContainer");if(!$soundContainer.length)$soundContainer=$("<div>").attr("id","soundContainer").appendTo($("body"));var baseFileName=this.options.chatJsContentPath+"sounds/chat";var oggFileName=baseFileName+".ogg";var mp3FileName=baseFileName+".mp3";var $audioTag=$("<audio/>").attr("autoplay","autoplay");$("<source/>").attr("src",oggFileName).attr("type","audio/mpeg").appendTo($audioTag);$("<embed/>").attr("src",mp3FileName).attr("autostart","true").attr("loop","false").appendTo($audioTag);$audioTag.appendTo($soundContainer)};MessageBoard.prototype.focus=function(){this.$textBox.focus()};MessageBoard.prototype.addMessage=function(message,clientGuid,scroll){if(scroll==undefined)scroll=true;if(message.UserFromId!=this.options.userId){this.removeTypingSignal()}function linkify($element){var inputText=$element.html();var replacedText,replacePattern1,replacePattern2,replacePattern3;replacePattern1=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;replacedText=inputText.replace(replacePattern1,'<a href="$1" target="_blank">$1</a>');replacePattern2=/(^|[^\/])(www\.[\S]+(\b|$))/gim;replacedText=replacedText.replace(replacePattern2,'$1<a href="http://$2" target="_blank">$2</a>');replacePattern3=/(\w+@[a-zA-Z_]+?\.[a-zA-Z]{2,6})/gim;replacedText=replacedText.replace(replacePattern3,'<a href="mailto:$1">$1</a>');return $element.html(replacedText)}function emotify($element){var inputText=$element.html();var replacedText=inputText;var emoticons=[{pattern:":-)",cssClass:"happy"},{pattern:":)",cssClass:"happy"},{pattern:"=)",cssClass:"happy"},{pattern:":-D",cssClass:"very-happy"},{pattern:":D",cssClass:"very-happy"},{pattern:"=D",cssClass:"very-happy"},{pattern:":-(",cssClass:"sad"},{pattern:":(",cssClass:"sad"},{pattern:"=(",cssClass:"sad"},{pattern:":-|",cssClass:"wary"},{pattern:":|",cssClass:"wary"},{pattern:"=|",cssClass:"wary"},{pattern:":-O",cssClass:"astonished"},{pattern:":O",cssClass:"astonished"},{pattern:"=O",cssClass:"astonished"},{pattern:":-P",cssClass:"tongue"},{pattern:":P",cssClass:"tongue"},{pattern:"=P",cssClass:"tongue"}];for(var i=0;i<emoticons.length;i++){replacedText=replacedText.replace(emoticons[i].pattern,"<span class='"+emoticons[i].cssClass+"'></span>")}return $element.html(replacedText)}if(message.ClientGuid&&$("p[data-val-client-guid='"+message.ClientGuid+"']").length){$("p[data-val-client-guid='"+message.ClientGuid+"']").removeClass("temp-message").removeAttr("data-val-client-guid")}else{var $messageP=$("<p/>").text(message.Message);if(clientGuid)$messageP.attr("data-val-client-guid",clientGuid).addClass("temp-message");linkify($messageP);emotify($messageP);var $lastMessage=$("div.chat-message:last",this.$messagesWrapper);if($lastMessage.length&&$lastMessage.attr("data-val-user-from")==message.UserFromId.toString()){$messageP.appendTo($(".chat-text-wrapper",$lastMessage))}else{var $chatMessage=$("<div/>").addClass("chat-message").attr("data-val-user-from",message.UserFromId);$chatMessage.appendTo(this.$messagesWrapper);var $gravatarWrapper=$("<div/>").addClass("chat-gravatar-wrapper").appendTo($chatMessage);var $textWrapper=$("<div/>").addClass("chat-text-wrapper").appendTo($chatMessage);$messageP.appendTo($textWrapper);var $img=$("<img/>").addClass("profile-picture").appendTo($gravatarWrapper);this.options.adapter.server.getUserInfo(message.UserFromId,function(user){$img.attr("src",decodeURI(user.ProfilePictureUrl))})}}if(scroll)this.adjustScroll()};return MessageBoard}();$.fn.messageBoard=function(options){if(this.length){this.each(function(){var data=new MessageBoard($(this),options);$(this).data("messageBoard",data)})}return this};var UserListOptions=function(){function UserListOptions(){}return UserListOptions}();var UserList=function(){function UserList(jQuery,options){var _this=this;this.$el=jQuery;var defaultOptions=new UserListOptions;defaultOptions.emptyListText="No users";defaultOptions.height=100;defaultOptions.userClicked=function(){};this.options=$.extend({},defaultOptions,options);this.$el.addClass("user-list");ChatJsUtils.setOuterHeight(this.$el,this.options.height);this.options.adapter.client.onUserListChanged(function(userListData){if(_this.options.roomId&&userListData.RoomId==_this.options.roomId||_this.options.conversationId&&_this.options.conversationId==userListData.ConversationId)_this.populateList(userListData.UserList)});this.options.adapter.server.getUserList(this.options.roomId,this.options.conversationId,function(userList){_this.populateList(userList)})}UserList.prototype.populateList=function(userList){var _this=this;this.$el.html("");if(userList.length==0){$("<div/>").addClass("user-list-empty").text(this.options.emptyListText).appendTo(this.$el)}else{for(var i=0;i<userList.length;i++){var $userListItem=$("<div/>").addClass("user-list-item").attr("data-val-id",userList[i].Id).appendTo(this.$el);$("<img/>").addClass("profile-picture").attr("src",userList[i].ProfilePictureUrl).appendTo($userListItem);$("<div/>").addClass("profile-status").addClass(userList[i].Status==0?"offline":"online").appendTo($userListItem);$("<div/>").addClass("content").text(userList[i].Name).appendTo($userListItem);(function(userId){$userListItem.click(function(){_this.options.userClicked(userId)})})(userList[i].Id)}}};return UserList}();$.fn.userList=function(options){if(this.length){this.each(function(){var data=new UserList($(this),options);$(this).data("userList",data)})}return this};var ChatRoomsOptions=function(){function ChatRoomsOptions(){}return ChatRoomsOptions}();var ChatRoomsState=function(){function ChatRoomsState(){}return ChatRoomsState}();var ChatRooms=function(){function ChatRooms(options){var _this=this;var defaultOptions=new ChatRoomsOptions;defaultOptions.titleText="Rooms";defaultOptions.noRoomsText="There's no rooms";defaultOptions.userClicked=function(){};defaultOptions.onStateChanged=function(){};defaultOptions.offsetRight=10;defaultOptions.contentHeight=235;defaultOptions.isMaximized=true;defaultOptions.chatJsContentPath="/content/chatjs/";this.options=$.extend({},defaultOptions,options);var chatWindowOptions=new ChatWindowOptions;chatWindowOptions.title=this.options.titleText;chatWindowOptions.canClose=false;chatWindowOptions.canExpand=true;chatWindowOptions.width=400;chatWindowOptions.height=300;chatWindowOptions.isMaximized=this.options.isMaximized;chatWindowOptions.onMaximizedStateChanged=function(){_this.options.onStateChanged()};var availableRoomsTabBuilder=function(roomList,$content){$content.html("");var $roomListWrapper=$("<div/>").addClass("rooms-list").appendTo($content);ChatJsUtils.setOuterHeight($roomListWrapper,_this.options.contentHeight);if(roomList.length==0){$("<div/>").addClass("user-list-empty").text(_this.options.noRoomsText).appendTo($roomListWrapper)}else{for(var i=0;i<roomList.length;i++){var $roomListItem=$("<div/>").addClass("rooms-list-item").attr("data-val-id",roomList[i].Id).appendTo($roomListWrapper);$roomListItem.hover(function(){$(this).addClass("hover")},function(){$(this).removeClass("hover")});$("<span/>").addClass("room-name").text(roomList[i].Name).appendTo($roomListItem);$("<span/>").addClass("users-online").text(roomList[i].UsersOnline+" online").appendTo($roomListItem);$roomListItem.hover(function(){$(this).addClass("hover")},function(){$(this).removeClass("hover")});(function(roomIndex){$roomListItem.click(function(){if(_this.tabs.hasTab(roomList[roomIndex].Id))_this.tabs.focusTab(roomList[roomIndex].Id);else _this.enterRoom(roomList[roomIndex].Id,roomList[roomIndex].Name);_this.options.onStateChanged()})})(i)}}};chatWindowOptions.onCreated=function(window){var $ul=$("<ul/>").appendTo(window.$windowInnerContent);var horizontalTabOptions=new HorizontalTabsOptions;horizontalTabOptions.onTabClosed=function(id){_this.options.adapter.server.leaveRoom(id,function(){})};_this.tabs=$ul.horizontalTabs(horizontalTabOptions).data("horizontalTabs");_this.tabs.addTab(0,"Available rooms",true,false,function($content){_this.options.adapter.server.getRoomsList(function(roomList){availableRoomsTabBuilder(roomList,$content)})},function(){_this.options.onStateChanged()},true,false)};this.options.adapter.client.onRoomListChanged(function(roomList){var availableRoomsTab=_this.tabs.getTab(0);availableRoomsTabBuilder(roomList.Rooms,availableRoomsTab.$content)});this.chatWindow=$.chatWindow(chatWindowOptions);this.chatWindow.setRightOffset(this.options.offsetRight)}ChatRooms.prototype.enterRoom=function(roomId,roomName,saveState){var _this=this;if(typeof saveState==="undefined"){saveState=true}var $messageBoard;this.tabs.addTab(roomId,roomName,true,true,function($content){var $contentWrapper=$("<div/>").addClass("content-wrapper").appendTo($content);var $users=$("<div/>").addClass("right-panel").appendTo($contentWrapper);var $leftPanel=$("<div/>").addClass("left-panel").appendTo($contentWrapper);var messageBoardOptions=new MessageBoardOptions;messageBoardOptions.adapter=_this.options.adapter;messageBoardOptions.userId=_this.options.userId;messageBoardOptions.height=_this.options.contentHeight;messageBoardOptions.roomId=roomId;messageBoardOptions.chatJsContentPath=_this.options.chatJsContentPath;messageBoardOptions.newMessage=function(message){var focusedTabId=_this.tabs.getFucusedTabId();if(focusedTabId!=null&&focusedTabId!=roomId&&message.UserFromId!=_this.options.userId)_this.tabs.addEventMark(roomId)};$messageBoard=$leftPanel.messageBoard(messageBoardOptions);_this.options.adapter.server.enterRoom(roomId,function(){var userListOptions=new UserListOptions;userListOptions.adapter=_this.options.adapter;userListOptions.roomId=roomId;userListOptions.height=_this.options.contentHeight;userListOptions.userClicked=_this.options.userClicked;$users.userList(userListOptions)})},function(){if($messageBoard&&$messageBoard.data("messageBoard"))$messageBoard.data("messageBoard").focus();var focusedTabId=_this.tabs.getFucusedTabId();if(focusedTabId)_this.tabs.clearEventMarks(focusedTabId);_this.options.onStateChanged()},saveState,saveState)};ChatRooms.prototype.getState=function(){var state=new ChatRoomsState;state.isMaximized=this.chatWindow.isMaximized();state.activeRoom=this.tabs.getFucusedTabId();state.openedRooms=this.tabs.getTabIds();return state};ChatRooms.prototype.setState=function(state){var _this=this;this.options.adapter.server.getRoomsList(function(roomsList){for(var i=0;i<state.openedRooms.length;i++)if(!_this.tabs.hasTab(state.openedRooms[i])){for(var j=0;j<roomsList.length;j++){if(roomsList[j].Id==state.openedRooms[i]){_this.enterRoom(roomsList[j].Id,roomsList[j].Name,false);
break}}}_this.tabs.focusTab(state.activeRoom,false);_this.chatWindow.setMaximized(state.isMaximized)})};ChatRooms.prototype.getWidth=function(){return this.chatWindow.getWidth()};return ChatRooms}();$.chatRooms=function(options){var chatRooms=new ChatRooms(options);return chatRooms};var ChatPmWindowOptions=function(){function ChatPmWindowOptions(){}return ChatPmWindowOptions}();var ChatPmWindow=function(){function ChatPmWindow(options){var _this=this;var defaultOptions=new ChatPmWindowOptions;defaultOptions.typingText=" is typing...";defaultOptions.isMaximized=true;defaultOptions.onCreated=function(){};defaultOptions.onClose=function(){};defaultOptions.chatJsContentPath="/content/chatjs/";this.options=$.extend({},defaultOptions,options);this.options.adapter.server.getUserInfo(this.options.otherUserId,function(userInfo){var chatWindowOptions=new ChatWindowOptions;chatWindowOptions.title=userInfo.Name;chatWindowOptions.canClose=true;chatWindowOptions.canExpand=false;chatWindowOptions.isMaximized=_this.options.isMaximized;chatWindowOptions.onCreated=function(window){var messageBoardOptions=new MessageBoardOptions;messageBoardOptions.adapter=_this.options.adapter;messageBoardOptions.userId=_this.options.userId;messageBoardOptions.height=235;messageBoardOptions.otherUserId=_this.options.otherUserId;messageBoardOptions.chatJsContentPath=_this.options.chatJsContentPath;window.$windowInnerContent.messageBoard(messageBoardOptions);window.$windowInnerContent.addClass("pm-window")};chatWindowOptions.onClose=function(){_this.options.onClose(_this)};chatWindowOptions.onMaximizedStateChanged=function(chatPmWindow,isMaximized){_this.options.onMaximizedStateChanged(_this,isMaximized)};_this.chatWindow=$.chatWindow(chatWindowOptions);_this.options.onCreated(_this)})}ChatPmWindow.prototype.focus=function(){};ChatPmWindow.prototype.setRightOffset=function(offset){this.chatWindow.setRightOffset(offset)};ChatPmWindow.prototype.getWidth=function(){return this.chatWindow.getWidth()};ChatPmWindow.prototype.isMaximized=function(){return this.chatWindow.isMaximized()};return ChatPmWindow}();$.chatPmWindow=function(options){var pmWindow=new ChatPmWindow(options);return pmWindow};var ChatControllerOptions=function(){function ChatControllerOptions(){}return ChatControllerOptions}();var PmWindowInfo=function(){function PmWindowInfo(){}return PmWindowInfo}();var PmWindowState=function(){function PmWindowState(){}return PmWindowState}();var ChatJsState=function(){function ChatJsState(){this.pmWindows=[];this.rooms=new ChatRoomsState}return ChatJsState}();var ChatController=function(){function ChatController(options){var _this=this;var defaultOptions=new ChatControllerOptions;defaultOptions.emptyRoomText="There's no other users";defaultOptions.typingText=" is typing...";defaultOptions.allowRoomSelection=true;defaultOptions.offsetRight=10;defaultOptions.windowsSpacing=2;defaultOptions.enableSound=true;defaultOptions.persistenceMode="cookie";defaultOptions.persistenceCookieName="chatjs";defaultOptions.chatJsContentPath="/chatjs/";this.options=$.extend({},defaultOptions,options);this.pmWindows=[];this.options.adapter.init(function(){var state=_this.getState();_this.options.adapter.client.onMessagesChanged(function(message){if(message.UserToId&&message.UserToId==_this.options.userId&&!_this.findPmWindowByOtherUserId(message.UserFromId)){_this.createPmWindow(message.UserFromId,true,true)}});var chatRoomOptions=new ChatRoomsOptions;chatRoomOptions.adapter=_this.options.adapter;chatRoomOptions.userId=_this.options.userId;chatRoomOptions.offsetRight=_this.options.offsetRight;chatRoomOptions.isMaximized=state?state.rooms.isMaximized:true;chatRoomOptions.onStateChanged=function(){_this.saveState()};chatRoomOptions.userClicked=function(userId){if(userId!=_this.options.userId){var existingPmWindow=_this.findPmWindowByOtherUserId(userId);if(existingPmWindow)existingPmWindow.focus();else _this.createPmWindow(userId,true,true)}};_this.chatRooms=$.chatRooms(chatRoomOptions);_this.loadState(state)});window.chatJs=this}ChatController.prototype.createPmWindow=function(otherUserId,isMaximized,saveState){var _this=this;var chatPmOptions=new ChatPmWindowOptions;chatPmOptions.userId=this.options.userId;chatPmOptions.otherUserId=otherUserId;chatPmOptions.adapter=this.options.adapter;chatPmOptions.typingText=this.options.typingText;chatPmOptions.isMaximized=isMaximized;chatPmOptions.chatJsContentPath=this.options.chatJsContentPath;chatPmOptions.onCreated=function(){_this.organizePmWindows();if(saveState)_this.saveState()};chatPmOptions.onClose=function(){for(var i=0;i<_this.pmWindows.length;i++)if(_this.pmWindows[i].otherUserId==otherUserId){_this.pmWindows.splice(i,1);_this.saveState();_this.organizePmWindows();break}};chatPmOptions.onMaximizedStateChanged=function(){_this.saveState()};var pmWindow=$.chatPmWindow(chatPmOptions);this.pmWindows.push({otherUserId:otherUserId,conversationId:null,pmWindow:pmWindow});return pmWindow};ChatController.prototype.saveState=function(){var state=new ChatJsState;for(var i=0;i<this.pmWindows.length;i++){state.pmWindows.push({otherUserId:this.pmWindows[i].otherUserId,conversationId:null,isMaximized:this.pmWindows[i].pmWindow.isMaximized()})}state.rooms=this.chatRooms.getState();switch(this.options.persistenceMode){case"cookie":this.createCookie(this.options.persistenceCookieName,state);break;case"server":throw"Server persistence is not supported yet";default:throw"Invalid persistence mode. Available modes are: cookie and server"}return state};ChatController.prototype.getState=function(){var state;switch(this.options.persistenceMode){case"cookie":state=this.readCookie(this.options.persistenceCookieName);break;case"server":throw"Server persistence is not supported yet";default:throw"Invalid persistence mode. Available modes are: cookie and server"}return state};ChatController.prototype.loadState=function(state){if(typeof state==="undefined"){state=null}if(!state)state=this.getState();if(!state)return;for(var i=0;i<state.pmWindows.length;i++){var shouldCreatePmWindow=true;if(this.pmWindows.length){for(var j=0;j<this.pmWindows.length;j++){if(state.pmWindows[i].otherUserId&&this.pmWindows[j].otherUserId==state.pmWindows[j].otherUserId){shouldCreatePmWindow=false;break}}}if(shouldCreatePmWindow)this.createPmWindow(state.pmWindows[i].otherUserId,state.pmWindows[i].isMaximized,false)}this.chatRooms.setState(state.rooms)};ChatController.prototype.eraseCookie=function(name){this.createCookie(name,"",-1)};ChatController.prototype.readCookie=function(name){var nameEq=name+"=";var ca=document.cookie.split(";");var cookieValue;for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==" ")c=c.substring(1,c.length);if(c.indexOf(nameEq)==0){cookieValue=c.substring(nameEq.length,c.length)}}if(cookieValue){try{return JSON.parse(cookieValue)}catch(e){return cookieValue}}else return null};ChatController.prototype.createCookie=function(name,value,days){var stringedValue;if(typeof value=="string")stringedValue=value;else stringedValue=JSON.stringify(value);if(value)var expires;if(days){var date=new Date;date.setTime(date.getTime()+days*24*60*60*1e3);expires="; expires="+date.toUTCString()}else{expires=""}document.cookie=name+"="+stringedValue+expires+"; path=/"};ChatController.prototype.findPmWindowByOtherUserId=function(otherUserId){for(var i=0;i<this.pmWindows.length;i++)if(this.pmWindows[i].otherUserId==otherUserId)return this.pmWindows[i].pmWindow;return null};ChatController.prototype.organizePmWindows=function(){var rightOffset=+this.options.offsetRight+this.chatRooms.getWidth()+this.options.windowsSpacing;for(var i=0;i<this.pmWindows.length;i++){this.pmWindows[i].pmWindow.setRightOffset(rightOffset);rightOffset+=this.pmWindows[i].pmWindow.getWidth()+this.options.windowsSpacing}};return ChatController}();$.chat=function(options){var chat=new ChatController(options);return chat};